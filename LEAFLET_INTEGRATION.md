# Leaflet + 热力图集成说明

## 📋 功能概述

成功将水污染扩散模拟系统从 Canvas 动画升级为 **Leaflet 地图 + 热力图** 展示方式。

## 🎯 主要改进

### 1. **真实地图背景**
- 使用 Leaflet 作为地图引擎
- 深色主题地图（CartoDB Dark）
- 支持缩放、平移等交互操作

### 2. **热力图可视化**
- 使用 `leaflet.heat` 插件
- 实时计算污染物浓度分布
- 蓝→青→绿→黄→橙→红 的颜色渐变
- 支持 1D、2D、3D 三种维度

### 3. **智能计算**
- 网格分辨率：5米
- 最大计算距离：200米
- 自动过滤低浓度点（< 0.001 mg/L）
- 实时更新频率：100ms

### 4. **交互式标记**
- 🔴 红色标记：污染源位置（坐标 0,0）
- 🟢 绿色标记：观测点位置（可配置）
- 点击标记可查看详细信息

## 🔧 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Leaflet | 1.9.4 | 2D 地图引擎 |
| Leaflet.heat | 0.2.0 | 热力图插件 |
| Vue 3 | 3.5.13 | 前端框架 |
| ECharts | 6.0.0 | 浓度趋势图表 |
| mathjs | 15.0.0 | 科学计算 |

## 📊 数据流程

```
用户输入参数
    ↓
启动模拟
    ↓
每帧更新（requestAnimationFrame）
    ↓
计算网格点浓度（使用污染计算公式）
    ↓
生成热力图数据 [lat, lng, intensity]
    ↓
更新 Leaflet 热力图层
    ↓
显示在地图上
```

## 🎨 颜色映射

| 浓度范围 (mg/L) | 颜色 | 污染等级 |
|----------------|------|---------|
| 0 - 2 | 蓝色 | 安全 |
| 2 - 4 | 青色 | 轻度 |
| 4 - 6 | 绿色/黄色 | 中度 |
| 6 - 8 | 橙色 | 重度 |
| 8+ | 红色 | 严重 |

## 🚀 使用方法

### 1. 启动开发服务器
```bash
npm run dev
```

### 2. 访问模拟页面
导航到 `/simulation` 路由

### 3. 配置参数
- **计算模式**：正演（预测浓度）或反演（定位污染源）
- **污染源类型**：瞬时源或初始有限源
- **维度**：1D、2D 或 3D
- **物理参数**：扩散系数、投放质量、初始浓度等
- **观测点位置**：设置 X、Y、Z 坐标

### 4. 控制模拟
- 点击「播放」开始模拟
- 点击「暂停」暂停模拟
- 点击「重置」重置模拟
- 调整「播放速度」改变时间流速

### 5. 查看结果
- **地图**：实时热力图显示污染扩散
- **观测点数据**：显示特定点的浓度值
- **浓度趋势图**：观测点浓度随时间变化曲线
- **预警系统**：自动检测浓度超标情况

## 🔑 核心函数

### `initMap()`
初始化 Leaflet 地图和热力图层

### `calculateHeatmapData()`
根据当前时间和参数计算所有网格点的浓度

### `updateHeatmap()`
更新热力图显示

### `updateObservationMarker()`
更新观测点标记位置

### `metersToLatLng(x, y)`
将米坐标转换为经纬度坐标

## 📐 坐标系统

- **污染源**：地图中心（经纬度：30.5728°N, 104.0668°E）
- **坐标原点**：污染源位置为 (0, 0)
- **单位**：米（m）
- **转换比例**：1 米 ≈ 0.00001 度（经纬度）

## ⚙️ 配置项

在 `CONSTANTS` 对象中可以调整以下参数：

```javascript
const CONSTANTS = {
  MAP_CENTER: [30.5728, 104.0668],  // 地图中心坐标（可修改为实际位置）
  MAP_ZOOM: 15,                      // 初始缩放级别
  METERS_TO_LATLNG: 0.00001,        // 米到经纬度转换系数
  
  HEATMAP_RADIUS: 25,               // 热力点半径
  HEATMAP_BLUR: 35,                 // 模糊程度
  
  GRID_RESOLUTION: 5,               // 网格分辨率（米）
  MAX_DISTANCE: 200,                // 最大计算距离（米）
  UPDATE_INTERVAL: 100,             // 更新间隔（毫秒）
};
```

## 🎯 性能优化

1. **网格采样**：不计算所有点，使用 5 米间隔的网格
2. **浓度过滤**：忽略浓度 < 0.001 的点
3. **更新节流**：100ms 更新一次热力图
4. **计算优化**：使用现有的优化数学公式

## 🐛 注意事项

1. **地图加载**：首次加载需要从网络下载地图瓦片
2. **计算量**：2D 和 3D 模式下计算量较大，建议调整网格分辨率
3. **坐标精度**：经纬度转换为近似值，适合演示，实际应用需要精确的投影转换
4. **浏览器兼容性**：需要支持 ES6+ 的现代浏览器

## 📚 相关文档

- [Leaflet 官方文档](https://leafletjs.com/)
- [Leaflet.heat 插件](https://github.com/Leaflet/Leaflet.heat)
- [污染计算公式说明](src/utils/pollutionCalculator.js)

## 🎨 自定义地图样式

可以更换不同的地图样式：

```javascript
// 当前使用：深色主题
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')

// 替换选项：
// 1. OpenStreetMap 标准
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'

// 2. CartoDB 浅色主题
'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'

// 3. 卫星影像（需要 Mapbox token）
'https://api.mapbox.com/styles/v1/mapbox/satellite-v9/...'
```

## ✅ 测试清单

- [x] 地图初始化
- [x] 热力图渲染
- [x] 污染源标记
- [x] 观测点标记
- [x] 1D 模拟
- [x] 2D 模拟
- [x] 3D 模拟
- [x] 瞬时源计算
- [x] 有限源计算
- [x] 播放/暂停/重置控制
- [x] 参数实时调整
- [x] 浓度趋势图
- [x] 预警系统
- [x] 响应式布局

---

**更新日期**: 2024年11月9日
**版本**: 2.0 (Leaflet 热力图版本)

